{"version":3,"sources":["../../../src/verification/truth-db-adapter.ts"],"sourcesContent":["/**\n * TruthDBAdapter - Persistence Layer for Verification Results\n *\n * Bridges the VerificationHookManager to AgentDB for persistent storage\n * of truth scores, validation results, and verification contexts.\n *\n * Storage: .agentdb/truth-scores.db (physically segregated from main memory)\n *\n * @module verification/truth-db-adapter\n */\n\nimport { AgentDBBackend } from '../memory/backends/agentdb.js';\n\n/**\n * Document structure for persisted truth scores\n */\nexport interface TruthScoreDocument {\n  taskId: string;\n  sessionId: string;\n  timestamp: number;\n  phase: string;\n  accuracyScore: number;\n  confidenceScore: number;\n  passed: boolean;\n  checksPassed: string[];\n  checksFailed: string[];\n  errorCount: number;\n  metadata: Record<string, unknown>;\n}\n\n/**\n * Snapshot document for rollback capability\n */\nexport interface SnapshotDocument {\n  snapshotId: string;\n  taskId: string;\n  timestamp: number;\n  phase: string;\n  state: unknown;\n  metadata: Record<string, unknown>;\n}\n\n/**\n * TruthDBAdapter - Persistent storage adapter for verification contexts\n *\n * Uses AgentDB with physical segregation to avoid polluting main memory.\n */\nexport class TruthDBAdapter {\n  private backend: AgentDBBackend;\n  private initialized: boolean = false;\n  private initPromise: Promise<void> | null = null;\n\n  constructor() {\n    // Physical segregation - separate DB file from main memory\n    this.backend = new AgentDBBackend({\n      dbPath: '.agentdb/truth-scores.db',\n      enableHNSW: true,\n      quantization: 'scalar'\n    });\n  }\n\n  /**\n   * Initialize the database connection\n   * Safe to call multiple times - will only initialize once\n   */\n  async initialize(): Promise<boolean> {\n    if (this.initialized) {\n      return true;\n    }\n\n    if (this.initPromise) {\n      await this.initPromise;\n      return this.initialized;\n    }\n\n    this.initPromise = this._doInitialize();\n    await this.initPromise;\n    return this.initialized;\n  }\n\n  private async _doInitialize(): Promise<void> {\n    try {\n      await this.backend.initialize();\n      this.initialized = true;\n      console.error(`[${new Date().toISOString()}] INFO [TruthDBAdapter] Initialized at .agentdb/truth-scores.db`);\n    } catch (error) {\n      console.error(`[${new Date().toISOString()}] ERROR [TruthDBAdapter] Initialization failed:`, (error as Error).message);\n      // Don't throw - allow graceful degradation\n      this.initialized = false;\n    }\n  }\n\n  /**\n   * Check if adapter is ready for operations\n   */\n  isReady(): boolean {\n    return this.initialized;\n  }\n\n  /**\n   * Save a verification context to persistent storage\n   *\n   * @param taskId - Unique task identifier\n   * @param data - Verification context data to persist\n   */\n  async saveContext(taskId: string, data: TruthScoreDocument): Promise<void> {\n    if (!this.initialized) {\n      await this.initialize();\n    }\n\n    if (!this.initialized) {\n      console.warn(`[TruthDBAdapter] Not initialized, skipping save for ${taskId}`);\n      return;\n    }\n\n    const key = `truth:${taskId}`;\n    const embedding = this.generateEmbedding(data);\n\n    try {\n      await this.backend.storeVector(key, embedding, {\n        ...data,\n        _type: 'truth_score',\n        _storedAt: Date.now(),\n        _version: 1\n      });\n    } catch (error) {\n      console.error(`[TruthDBAdapter] Failed to save context ${taskId}:`, (error as Error).message);\n      throw error;\n    }\n  }\n\n  /**\n   * Retrieve a verification context by task ID\n   *\n   * @param taskId - Unique task identifier\n   * @returns The stored document or null if not found\n   */\n  async getContext(taskId: string): Promise<TruthScoreDocument | null> {\n    if (!this.initialized) {\n      await this.initialize();\n    }\n\n    if (!this.initialized) {\n      return null;\n    }\n\n    const key = `truth:${taskId}`;\n\n    try {\n      const result = await this.backend.getVector(key);\n      if (!result || !result.metadata) {\n        return null;\n      }\n      return result.metadata as TruthScoreDocument;\n    } catch (error) {\n      console.error(`[TruthDBAdapter] Failed to get context ${taskId}:`, (error as Error).message);\n      return null;\n    }\n  }\n\n  /**\n   * Delete a verification context\n   *\n   * @param taskId - Unique task identifier\n   * @returns true if deleted, false otherwise\n   */\n  async deleteContext(taskId: string): Promise<boolean> {\n    if (!this.initialized) {\n      return false;\n    }\n\n    const key = `truth:${taskId}`;\n\n    try {\n      return await this.backend.deleteVector(key);\n    } catch (error) {\n      console.error(`[TruthDBAdapter] Failed to delete ${taskId}:`, (error as Error).message);\n      return false;\n    }\n  }\n\n  /**\n   * Save a state snapshot for rollback capability\n   *\n   * @param taskId - Parent task identifier\n   * @param snapshot - Snapshot data to persist\n   */\n  async saveSnapshot(taskId: string, snapshot: SnapshotDocument): Promise<void> {\n    if (!this.initialized) {\n      await this.initialize();\n    }\n\n    if (!this.initialized) {\n      return;\n    }\n\n    const key = `snapshot:${taskId}:${snapshot.snapshotId}`;\n    const embedding = this.generateSnapshotEmbedding(snapshot);\n\n    try {\n      await this.backend.storeVector(key, embedding, {\n        ...snapshot,\n        _type: 'snapshot',\n        _storedAt: Date.now()\n      });\n    } catch (error) {\n      console.error(`[TruthDBAdapter] Failed to save snapshot:`, (error as Error).message);\n    }\n  }\n\n  /**\n   * Get all snapshots for a task (for rollback)\n   *\n   * @param taskId - Task identifier to get snapshots for\n   * @returns Array of snapshots sorted by timestamp\n   */\n  async getSnapshots(taskId: string): Promise<SnapshotDocument[]> {\n    if (!this.initialized) {\n      return [];\n    }\n\n    try {\n      // Use search to find all snapshots for this task\n      const queryEmbedding = this.generateSnapshotEmbedding({\n        snapshotId: '',\n        taskId,\n        timestamp: Date.now(),\n        phase: 'query',\n        state: null,\n        metadata: {}\n      });\n\n      const results = await this.backend.search(queryEmbedding, {\n        k: 100,\n        filter: { taskId, _type: 'snapshot' }\n      });\n\n      return results\n        .map(r => r.metadata as SnapshotDocument)\n        .filter(s => s && s.snapshotId)\n        .sort((a, b) => a.timestamp - b.timestamp);\n    } catch (error) {\n      console.error(`[TruthDBAdapter] Failed to get snapshots for ${taskId}:`, (error as Error).message);\n      return [];\n    }\n  }\n\n  /**\n   * Search for similar verification contexts (semantic search)\n   *\n   * @param query - Query document for similarity search\n   * @param k - Number of results to return\n   * @returns Array of similar documents\n   */\n  async searchSimilar(query: Partial<TruthScoreDocument>, k: number = 10): Promise<TruthScoreDocument[]> {\n    if (!this.initialized) {\n      return [];\n    }\n\n    try {\n      const embedding = this.generateEmbedding(query as TruthScoreDocument);\n      const results = await this.backend.search(embedding, { k });\n      return results\n        .map(r => r.metadata as TruthScoreDocument)\n        .filter(d => d && d._type === 'truth_score');\n    } catch (error) {\n      console.error(`[TruthDBAdapter] Search failed:`, (error as Error).message);\n      return [];\n    }\n  }\n\n  /**\n   * Get database statistics\n   */\n  async getStats(): Promise<{\n    initialized: boolean;\n    vectorCount?: number;\n    dbPath?: string;\n    error?: string;\n  }> {\n    if (!this.initialized) {\n      return { initialized: false, error: 'Not initialized' };\n    }\n\n    try {\n      const stats = await this.backend.getStats();\n      return {\n        initialized: true,\n        vectorCount: stats.vectorCount,\n        dbPath: '.agentdb/truth-scores.db'\n      };\n    } catch (error) {\n      return {\n        initialized: true,\n        error: (error as Error).message\n      };\n    }\n  }\n\n  /**\n   * Close database connection\n   */\n  async close(): Promise<void> {\n    if (this.initialized) {\n      await this.backend.close();\n      this.initialized = false;\n    }\n  }\n\n  // ===== Private Methods =====\n\n  /**\n   * Generate embedding vector for truth score documents\n   *\n   * Creates a numerical representation for HNSW semantic search.\n   * Uses feature-based embedding (128 dimensions).\n   */\n  private generateEmbedding(doc: TruthScoreDocument): number[] {\n    const embedding = new Array(128).fill(0);\n\n    // Accuracy features (dims 0-15)\n    embedding[0] = doc.accuracyScore ?? 0;\n    embedding[1] = doc.confidenceScore ?? 0;\n    embedding[2] = doc.passed ? 1 : 0;\n    embedding[3] = Math.min((doc.errorCount ?? 0) / 10, 1); // Normalized\n    embedding[4] = Math.min((doc.checksPassed?.length ?? 0) / 20, 1);\n    embedding[5] = Math.min((doc.checksFailed?.length ?? 0) / 20, 1);\n\n    // Temporal features (dims 16-31)\n    const timestamp = doc.timestamp ?? Date.now();\n    const dayNorm = (timestamp % 86400000) / 86400000; // Time of day\n    embedding[16] = dayNorm;\n    embedding[17] = Math.sin(dayNorm * 2 * Math.PI); // Cyclic encoding\n    embedding[18] = Math.cos(dayNorm * 2 * Math.PI);\n\n    // Phase encoding (dims 32-47)\n    const phases = ['pre-task', 'execution', 'post-task', 'validation', 'complete', 'failed'];\n    const phaseIndex = phases.indexOf(doc.phase ?? 'pre-task');\n    if (phaseIndex >= 0 && phaseIndex < 16) {\n      embedding[32 + phaseIndex] = 1;\n    }\n\n    // Task ID hash for grouping (dims 48-63)\n    if (doc.taskId) {\n      const hash = this.hashString(doc.taskId);\n      for (let i = 0; i < 16; i++) {\n        embedding[48 + i] = ((hash >> i) & 1) ? 0.5 : -0.5;\n      }\n    }\n\n    // Session ID hash (dims 64-79)\n    if (doc.sessionId) {\n      const hash = this.hashString(doc.sessionId);\n      for (let i = 0; i < 16; i++) {\n        embedding[64 + i] = ((hash >> i) & 1) ? 0.5 : -0.5;\n      }\n    }\n\n    return embedding;\n  }\n\n  /**\n   * Generate embedding for snapshots\n   */\n  private generateSnapshotEmbedding(snapshot: SnapshotDocument): number[] {\n    const embedding = new Array(128).fill(0);\n\n    // Temporal features\n    const timestamp = snapshot.timestamp ?? Date.now();\n    embedding[0] = (timestamp % 86400000) / 86400000;\n\n    // Phase encoding\n    const phases = ['pre-task', 'execution', 'post-task', 'validation', 'complete', 'failed'];\n    const phaseIndex = phases.indexOf(snapshot.phase ?? 'pre-task');\n    if (phaseIndex >= 0 && phaseIndex < 16) {\n      embedding[32 + phaseIndex] = 1;\n    }\n\n    // Task ID hash\n    if (snapshot.taskId) {\n      const hash = this.hashString(snapshot.taskId);\n      for (let i = 0; i < 16; i++) {\n        embedding[48 + i] = ((hash >> i) & 1) ? 0.5 : -0.5;\n      }\n    }\n\n    // Snapshot ID hash\n    if (snapshot.snapshotId) {\n      const hash = this.hashString(snapshot.snapshotId);\n      for (let i = 0; i < 16; i++) {\n        embedding[80 + i] = ((hash >> i) & 1) ? 0.5 : -0.5;\n      }\n    }\n\n    return embedding;\n  }\n\n  /**\n   * Simple string hash function\n   */\n  private hashString(str: string): number {\n    let hash = 0;\n    for (let i = 0; i < str.length; i++) {\n      const char = str.charCodeAt(i);\n      hash = ((hash << 5) - hash) + char;\n      hash = hash & hash; // Convert to 32-bit integer\n    }\n    return Math.abs(hash);\n  }\n}\n\n// Export singleton instance\nexport const truthDBAdapter = new TruthDBAdapter();\n"],"names":["AgentDBBackend","TruthDBAdapter","backend","initialized","initPromise","dbPath","enableHNSW","quantization","initialize","_doInitialize","console","error","Date","toISOString","message","isReady","saveContext","taskId","data","warn","key","embedding","generateEmbedding","storeVector","_type","_storedAt","now","_version","getContext","result","getVector","metadata","deleteContext","deleteVector","saveSnapshot","snapshot","snapshotId","generateSnapshotEmbedding","getSnapshots","queryEmbedding","timestamp","phase","state","results","search","k","filter","map","r","s","sort","a","b","searchSimilar","query","d","getStats","stats","vectorCount","close","doc","Array","fill","accuracyScore","confidenceScore","passed","Math","min","errorCount","checksPassed","length","checksFailed","dayNorm","sin","PI","cos","phases","phaseIndex","indexOf","hash","hashString","i","sessionId","str","char","charCodeAt","abs","truthDBAdapter"],"mappings":"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"}